{% extends "base.html" %}
{% from "macros/form.html" import autocomplete_field, text_field, date_field, price_field, scale_select, boolean_select, number_field %}

{% block title %}编辑动车组模型 - 火车模型管理系统{% endblock %}

{% block content %}
<h1>编辑动车组模型</h1>

<form id="trainset-form" method="POST">
  <div class="form-row">
    {{ autocomplete_field('model_id', '型号', trainset_models, required=true, value=trainset.model_id, text_value=trainset.model.name if trainset.model else None, onchange='autoFillTrainset()') }}
    {{ autocomplete_field('series_id', '系列', trainset_series, value=trainset.series_id, text_value=trainset.series.name if trainset.series else None, onchange='handleTrainsetSeriesChange()') }}
    {{ autocomplete_field('power_type_id', '动力类型', power_types, value=trainset.power_type_id, text_value=trainset.power_type.name if trainset.power_type else None) }}
    {{ autocomplete_field('depot_id', '动车段', depots, value=trainset.depot_id, text_value=trainset.depot.name if trainset.depot else None) }}
    {{ scale_select(value=trainset.scale) }}
    {{ autocomplete_field('brand_id', '品牌', brands, required=true, value=trainset.brand_id, text_value=trainset.brand.name if trainset.brand else None) }}
  </div>

  <div class="form-row">
    {{ text_field('trainset_number', '动车号', required=true, value=trainset.trainset_number) }}
    {{ text_field('decoder_number', '编号', value=trainset.decoder_number) }}
    {{ text_field('plaque', '挂牌', value=trainset.plaque) }}
    {{ text_field('color', '颜色', value=trainset.color) }}
    {{ number_field('formation', '编组数', value=trainset.formation) }}
  </div>

  <div class="form-row">
    {{ boolean_select('head_light', '头车灯', value=trainset.head_light) }}
    {{ text_field('interior_light', '室内灯', value=trainset.interior_light) }}
    {{ autocomplete_field('chip_interface_id', '芯片接口', chip_interfaces, value=trainset.chip_interface_id, text_value=trainset.chip_interface.name if trainset.chip_interface else None) }}
    {{ autocomplete_field('chip_model_id', '芯片型号', chip_models, value=trainset.chip_model_id, text_value=trainset.chip_model.name if trainset.chip_model else None) }}
  </div>

  <div class="form-row">
    {{ text_field('item_number', '货号', value=trainset.item_number) }}
    {{ price_field(value=trainset.price) }}
    {{ autocomplete_field('merchant_id', '购买商家', merchants, value=trainset.merchant_id, text_value=trainset.merchant.name if trainset.merchant else None) }}
    {{ date_field('purchase_date', '购买日期', value=trainset.purchase_date) }}
  </div>

  <div class="form-row">
    {{ text_field('product_url', '产品地址', value=trainset.product_url) }}
  </div>

  <button type="submit">保存</button>
  <a href="{{ url_for('trainset.trainset') }}" class="btn-cancel">取消</a>
</form>

{% if errors %}
<div class="error">
  {% for error in errors %}
  <p>{{ error }}</p>
  {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  window.trainsetSeriesData = [
    {% for series in trainset_series %}
    { id: '{{ series.id }}', name: '{{ series.name | replace("'", "\\'") }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  window.trainsetModelData = [
    {% for model in trainset_models %}
    { id: '{{ model.id }}', name: '{{ model.name | replace("'", "\\'") }}', series_id: '{{ model.series_id or '' }}', power_type_id: '{{ model.power_type_id or '' }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  function autoFillTrainset() {
    var value = AutocompleteManager.getValue('model_id_text');
    if (!value || !value.id) return;

    var modelId = value.id;
    var model = window.trainsetModelData.find(function(m) { return m.id === modelId; });
    if (model) {
      if (model.series_id) {
        var series = window.trainsetSeriesData.find(function(s) { return s.id === model.series_id; });
        if (series) {
          AutocompleteManager.setValue('series_id_text', model.series_id, series.name);
        }
      }
      if (model.power_type_id) {
        var powerTypes = [
          {% for pt in power_types %}
          { id: '{{ pt.id }}', name: '{{ pt.name }}' }{% if not loop.last %},{% endif %}
          {% endfor %}
        ];
        var pt = powerTypes.find(function(p) { return p.id === model.power_type_id; });
        if (pt) {
          AutocompleteManager.setValue('power_type_id_text', model.power_type_id, pt.name);
        }
      }
    }
  }

  function handleTrainsetSeriesChange() {
    // 系列变化时可以过滤型号（如果需要）
  }
</script>
{% endblock %}
