{% extends "base.html" %}
{% from "macros/form.html" import autocomplete_field, text_field, date_field, price_field, scale_select, boolean_select, number_field %}
{% from "macros/table.html" import action_buttons, relation_name %}

{% block title %}动车组模型 - 火车模型管理系统{% endblock %}

{% block content %}
<h1>动车组模型</h1>

<form id="trainset-form" onsubmit="event.preventDefault(); submitFormAjax(this, '/api/trainset/add');">
  <div class="form-grid-5">
    {{ autocomplete_field('model_id', '型号', trainset_models, required=true, onchange='autoFillTrainset()') }}
    {{ autocomplete_field('series_id', '系列', trainset_series, onchange='handleTrainsetSeriesChange()') }}
    {{ autocomplete_field('power_type_id', '动力', power_types) }}
    {{ autocomplete_field('depot_id', '动车段', depots) }}
    {{ scale_select() }}
  </div>

  <div class="form-grid-5">
    {{ text_field('trainset_number', '动车号', required=true) }}
    {{ text_field('decoder_number', '编号') }}
    {{ text_field('plaque', '挂牌') }}
    {{ autocomplete_field('chip_interface_id', '芯片接口', chip_interfaces) }}
    {{ autocomplete_field('chip_model_id', '芯片型号', chip_models) }}
  </div>

  <div class="form-grid-5">
    {{ number_field('formation', '编组', value=1) }}
    {{ boolean_select('head_light', '头车灯', default=true) }}
    {{ text_field('interior_light', '室内灯', field_class='col-3') }}
  </div>

  <div class="form-grid-5">
    {{ text_field('color', '涂装') }}
    {{ price_field() }}
    {{ autocomplete_field('merchant_id', '购买商家', merchants, field_class='col-2') }}
    {{ date_field('purchase_date', '购买日期') }}
  </div>

  <div class="form-grid-5">
    {{ autocomplete_field('brand_id', '品牌', brands, required=true) }}
    {{ text_field('item_number', '货号') }}
    {{ text_field('product_url', '产品地址', field_class='col-3') }}
  </div>

  <button type="submit">添加</button>
</form>

<div class="table-wrapper">
  <table id="trainset-table" class="sortable-filterable">
    <thead>
      <tr>
        <th data-sort="model" data-filter="model">型号</th>
        <th data-sort="series" data-filter="series">系列</th>
        <th data-sort="brand" data-filter="brand">品牌</th>
        <th data-sort="depot" data-filter="depot">动车段</th>
        <th data-sort="scale" data-filter="scale">比例</th>
        <th data-sort="number" data-filter="number">动车号</th>
        <th data-sort="decoder" data-filter="decoder">编号</th>
        <th data-sort="formation" data-filter="formation">编组</th>
        <th data-sort="head_light" data-filter="head_light">头车灯</th>
        <th data-sort="interior_light" data-filter="interior_light">室内灯</th>
        <th data-sort="chip_interface" data-filter="chip_interface">芯片接口</th>
        <th data-sort="chip_model" data-filter="chip_model">芯片型号</th>
        <th data-sort="item_number" data-filter="item_number">货号</th>
        <th data-sort="price">总价</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for trainset in trainsets %}
      <tr data-model="{{ trainset.model.name }}" data-model_id="{{ trainset.model_id }}" data-series="{{ trainset.series.name if trainset.series else '' }}" data-series_id="{{ trainset.series_id or '' }}" data-power_type="{{ trainset.power_type.name if trainset.power_type else '' }}" data-power_type_id="{{ trainset.power_type_id or '' }}" data-brand="{{ trainset.brand.name }}" data-brand_id="{{ trainset.brand_id }}" data-depot="{{ trainset.depot.name if trainset.depot else '' }}" data-depot_id="{{ trainset.depot_id or '' }}" data-scale="{{ trainset.scale }}" data-trainset_number="{{ trainset.trainset_number or '' }}" data-decoder_number="{{ trainset.decoder_number or '' }}" data-formation="{{ trainset.formation or '' }}" data-head_light="{{ 'true' if trainset.head_light else 'false' }}" data-interior_light="{{ trainset.interior_light or '' }}" data-chip_interface="{{ trainset.chip_interface.name if trainset.chip_interface else '' }}" data-chip_interface_id="{{ trainset.chip_interface_id or '' }}" data-chip_model="{{ trainset.chip_model.name if trainset.chip_model else '' }}" data-chip_model_id="{{ trainset.chip_model_id or '' }}" data-color="{{ trainset.color or '' }}" data-price="{{ trainset.price or '' }}" data-merchant="{{ trainset.merchant.name if trainset.merchant else '' }}" data-merchant_id="{{ trainset.merchant_id or '' }}" data-item_number="{{ trainset.item_number or '' }}" data-product_url="{{ trainset.product_url or '' }}" data-purchase_date="{{ trainset.purchase_date or '' }}">
        <td>{{ trainset.model.name }}</td>
        <td>{{ relation_name(trainset.series) }}</td>
        <td>{{ trainset.brand.name }}</td>
        <td>{{ relation_name(trainset.depot) }}</td>
        <td>{{ trainset.scale }}</td>
        <td>{{ trainset.trainset_number }}</td>
        <td>{{ trainset.decoder_number }}</td>
        <td>{{ trainset.formation }}</td>
        <td>{{ '有' if trainset.head_light else '无' }}</td>
        <td>{{ trainset.interior_light }}</td>
        <td>{{ relation_name(trainset.chip_interface) }}</td>
        <td>{{ relation_name(trainset.chip_model) }}</td>
        <td class="item-number-cell">
          {% if trainset.product_url %}
          <a href="{{ trainset.product_url }}" target="_blank" title="点击打开产品页面">{{ trainset.item_number }}</a>
          {% else %}
          {{ trainset.item_number }}
          {% endif %}
        </td>
        <td>{{ trainset.total_price }}</td>
        <td class="action-cell">
          {% set search_url = trainset.brand.search_url %}
          {% set item_number = trainset.item_number %}
          {% if search_url and item_number %}
          <button type="button" class="btn-search" onclick='searchProduct(this, {{ search_url | tojson }}, {{ item_number | tojson }})' title="在官网搜索此货号">检索</button>
          {% else %}
          <button type="button" class="btn-search" disabled title="缺少品牌搜索URL或货号">检索</button>
          {% endif %}
          <button type="button" class="btn-copy" onclick="copyTrainset(this)" title="复制此行数据到表单">复制</button>
          <a href="{{ url_for('trainset.edit_trainset', id=trainset.id) }}" class="btn-edit">编辑</a>
          <form action="{{ url_for('trainset.delete_trainset', id=trainset.id) }}" method="POST" onsubmit="return confirm('确定删除？')">
            <button type="submit" class="btn-danger">删除</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.trainsetSeriesData = [
    {% for series in trainset_series %}
    { id: '{{ series.id }}', name: '{{ series.name | replace("'", "\\'") }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  window.trainsetModelData = [
    {% for model in trainset_models %}
    { id: '{{ model.id }}', name: '{{ model.name | replace("'", "\\'") }}', series_id: '{{ model.series_id or '' }}', power_type_id: '{{ model.power_type_id or '' }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  window.trainsetPowerTypes = [
    {% for pt in power_types %}
    { id: '{{ pt.id }}', name: '{{ pt.name }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  initTableSortFilter('trainset-table');

  function autoFillTrainset() {
    var value = AutocompleteManager.getValue('model_id_text');
    if (!value || !value.id) return;

    var model = window.trainsetModelData.find(function(m) { return m.id === value.id; });
    if (model) {
      if (model.series_id) {
        var series = window.trainsetSeriesData.find(function(s) { return s.id === model.series_id; });
        if (series) {
          AutocompleteManager.setValue('series_id_text', model.series_id, series.name);
        }
      }
      if (model.power_type_id) {
        var pt = window.trainsetPowerTypes.find(function(p) { return p.id === model.power_type_id; });
        if (pt) {
          AutocompleteManager.setValue('power_type_id_text', model.power_type_id, pt.name);
        }
      }
    }
  }

  function handleTrainsetSeriesChange() {
    // 系列变化时的处理
  }

  // 搜索产品
  function searchProduct(btn, searchUrl, itemNumber) {
    if (!searchUrl || !itemNumber) return;
    var url = searchUrl.replace('{query}', encodeURIComponent(itemNumber));
    window.open(url, '_blank');
  }
</script>
{% endblock %}
