{% extends "base.html" %}

{% block title %}车厢模型 - 火车模型管理系统{% endblock %}

{% block content %}
<h1>车厢模型</h1>

<form id="carriage-form" method="POST">
  <div class="form-row">
    <div class="form-group">
      <label for="brand_id">品牌 *</label>
      <select id="brand_id" name="brand_id" required>
        <option value="">请选择</option>
        {% for brand in brands %}
        <option value="{{ brand.id }}">{{ brand.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="series_id">系列</label>
      <select id="series_id" name="series_id" onchange="autoFillCarriage()">
        <option value="">请选择</option>
        {% for series in carriage_series %}
        <option value="{{ series.id }}">{{ series.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="scale">比例 *</label>
      <select id="scale" name="scale" required>
        <option value="HO">HO</option>
        <option value="N">N</option>
      </select>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="depot_id">车辆段</label>
      <select id="depot_id" name="depot_id">
        <option value="">请选择</option>
        {% for depot in depots %}
        <option value="{{ depot.id }}">{{ depot.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="train_number">车次</label>
      <input type="text" id="train_number" name="train_number">
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="plaque">挂牌</label>
      <input type="text" id="plaque" name="plaque">
    </div>
    <div class="form-group">
      <label for="item_number">货号</label>
      <input type="text" id="item_number" name="item_number">
    </div>
  </div>

  <div class="form-group">
    <label for="total_price">总价</label>
    <input type="number" id="total_price" name="total_price" step="0.01">
  </div>

  <div class="form-group">
    <label for="purchase_date">购买日期</label>
    <input type="date" id="purchase_date" name="purchase_date" value="{{ today }}">
    </div>

  <div class="form-group">
    <label for="merchant_id">购买商家</label>
    <select id="merchant_id" name="merchant_id">
      <option value="">请选择</option>
        {% for merchant in merchants %}
        <option value="{{ merchant.id }}">{{ merchant.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <h3>车厢列表</h3>
  <div id="carriage-items">
    <!-- 车厢项将动态添加 -->
  </div>

  <button type="button" onclick="addCarriageRow()">添加车厢</button>
  <button type="submit">添加套装</button>
</form>

{% if errors %}
<div class="error">
  {% for error in errors %}
  <p>{{ error }}</p>
  {% endfor %}
</div>
{% endif %}

<table>
  <thead>
    <tr>
      <th>品牌</th>
      <th>系列</th>
      <th>车次</th>
      <th>比例</th>
      <th>车厢数</th>
      <th>总价</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for set in carriage_sets %}
    <tr>
      <td>{{ set.brand.name }}</td>
      <td>{{ set.series.name if set.series else '-' }}</td>
      <td>{{ set.train_number }}</td>
      <td>{{ set.scale }}</td>
      <td>{{ set.items|length }}</td>
      <td>{{ set.total_price }}</td>
      <td>
        <form method="POST" action="{{ url_for('delete_carriage', id=set.id) }}" onsubmit="return confirm('确定删除？')">
          <button type="submit" class="btn-danger">删除</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
function autoFillCarriage() {
  const modelId = document.getElementById('series_id').value;
  if (!modelId) return;

  fetch(`/api/auto-fill/carriage/${modelId}`)
    .then(response => response.json())
    .then(data => {
      // 系列ID已自动填充，类型需要额外字段
      document.getElementById('series_id').value = data.series_id;
    // 类型字段需要在后端添加
    // 暂时设置一个默认值
    if (data.type) {
        // 如果需要显示类型，可以添加一个隐藏字段
        console.log('Carriage type:', data.type);
      }
    });
}

let carriageItemCount = 0;

function addCarriageRow() {
  const container = document.getElementById('carriage-items');
  const newItem = document.createElement('div');
  newItem.className = 'carriage-item form-row';
  newItem.innerHTML = `
    <div class="form-group">
      <label>车型</label>
      <select name="model_${carriageItemCount}">
        <option value="">请选择</option>
        {% for model in carriage_models %}
        <option value="{{ model.id }}">{{ model.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label>车辆号</label>
      <input type="text" name="car_number_${carriageItemCount}" pattern="[0-9]{1,1}$">
    </div>
    <div class="form-group">
      <label>颜色</label>
      <input type="text" name="color_${carriageItemCount}">
    </div>
    <div class="form-group">
      <label>灯光</label>
      <input type="text" name="lighting_${carriageItemCount}">
    </div>
    <button type="button" onclick="removeCarriageRow(this)">删除</button>
  `;
  container.appendChild(newItem);
  carriageItemCount++;
}

function removeCarriageRow(button) {
  const container = document.getElementById('carriage-items');
  if (container.children.length > 1) {
    container.removeChild(button.parentElement);
  }
}
</script>
{% endblock %}
