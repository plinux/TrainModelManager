{% extends "base.html" %}
{% from "macros/form.html" import select_field, text_field, date_field, scale_select %}
{% from "macros/table.html" import action_buttons, relation_name %}

{% block title %}车厢模型 - 火车模型管理系统{% endblock %}

{% block content %}
<h1>车厢模型</h1>

<form id="carriage-form" onsubmit="event.preventDefault(); submitFormAjax(this, '/api/carriage/add');">
  <div class="form-row">
    {{ select_field('series_id', '系列', carriage_series, required=true, onchange='autoFillCarriage()') }}
    {{ select_field('depot_id', '车辆段', depots) }}
    {{ scale_select() }}
    {{ select_field('brand_id', '品牌', brands, required=true) }}
  </div>

  <div class="form-row">
    {{ text_field('train_number', '车次') }}
    {{ text_field('plaque', '挂牌') }}
    {{ text_field('item_number', '货号') }}
    <div class="form-group">
      <label for="total_price">总价</label>
      <input type="number" id="total_price" name="total_price" step="0.01">
    </div>
    {{ select_field('merchant_id', '购买商家', merchants) }}
    {{ date_field('purchase_date', '购买日期', value=today) }}
  </div>

  <h3>车厢列表</h3>
  <div id="carriage-items">
    <!-- 车厢项将动态添加 -->
  </div>

  <button type="button" onclick="addCarriageRow()">添加车厢</button>
  <button type="submit">添加套装</button>
</form>

<div class="table-wrapper">
  <table id="carriage-table" class="sortable-filterable">
    <thead>
      <tr>
        <th data-sort="series" data-filter="series">系列</th>
        <th data-sort="brand" data-filter="brand">品牌</th>
        <th data-sort="depot" data-filter="depot">车辆段</th>
        <th data-sort="train_number" data-filter="train_number">车次</th>
        <th data-sort="scale" data-filter="scale">比例</th>
        <th data-sort="item_number" data-filter="item_number">货号</th>
        <th data-sort="count">车厢数</th>
        <th data-sort="price">总价</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for set in carriage_sets %}
      <tr data-series="{{ set.series.name if set.series else '' }}" data-brand="{{ set.brand.name }}" data-depot="{{ set.depot.name if set.depot else '' }}" data-train_number="{{ set.train_number or '' }}" data-scale="{{ set.scale }}" data-item_number="{{ set.item_number or '' }}" data-count="{{ set.items|length }}" data-price="{{ set.total_price or 0 }}">
        <td>{{ relation_name(set.series) }}</td>
        <td>{{ set.brand.name }}</td>
        <td>{{ relation_name(set.depot) }}</td>
        <td>{{ set.train_number }}</td>
        <td>{{ set.scale }}</td>
        <td>{{ set.item_number }}</td>
        <td>{{ set.items|length }}</td>
        <td>{{ set.total_price }}</td>
        {{ action_buttons(url_for('carriage.edit_carriage', id=set.id), url_for('carriage.delete_carriage', id=set.id)) }}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.carriageSeriesData = [
    {% for series in carriage_series %}
    { id: {{ series.id }}, name: '{{ series.name }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  window.carriageModelData = [
    {% for model in carriage_models %}
    { id: {{ model.id }}, name: '{{ model.name }}', series_id: {{ model.series_id or 'null' }} }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  initTableSortFilter('carriage-table');
</script>
{% endblock %}
