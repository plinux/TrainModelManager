{% extends "base.html" %}
{% from "macros/form.html" import autocomplete_field, text_field, date_field, scale_select %}
{% from "macros/table.html" import relation_name %}

{% block title %}编辑车厢套装 - 火车模型管理系统{% endblock %}

{% block content %}
<h1>编辑车厢套装</h1>

<form id="carriage-form" method="POST">
  <div class="form-row">
    {{ autocomplete_field('series_id', '系列', carriage_series, value=carriage_set.series_id, text_value=carriage_set.series_rel.name if carriage_set.series_rel else None) }}
    {{ autocomplete_field('depot_id', '车辆段', depots, value=carriage_set.depot_id, text_value=carriage_set.depot_rel.name if carriage_set.depot_rel else None) }}
    {{ scale_select(value=carriage_set.scale) }}
    {{ autocomplete_field('brand_id', '品牌', brands, required=true, value=carriage_set.brand_id, text_value=carriage_set.brand_rel.name if carriage_set.brand_rel else None) }}
  </div>

  <div class="form-row">
    {{ text_field('train_number', '车次', value=carriage_set.train_number) }}
    {{ text_field('plaque', '挂牌', value=carriage_set.plaque) }}
    {{ text_field('item_number', '货号', value=carriage_set.item_number) }}
    <div class="form-group">
      <label for="total_price">总价</label>
      <input type="number" id="total_price" name="total_price" step="0.01" value="{{ carriage_set.total_price }}">
    </div>
    {{ autocomplete_field('merchant_id', '购买商家', merchants, value=carriage_set.merchant_id, text_value=carriage_set.merchant_rel.name if carriage_set.merchant_rel else None) }}
    {{ date_field('purchase_date', '购买日期', value=carriage_set.purchase_date) }}
  </div>

  <div class="form-row">
    {{ text_field('product_url', '产品地址', value=carriage_set.product_url) }}
  </div>

  <h3>车厢列表</h3>
  <div id="carriage-items">
    {% for item in carriage_set.items %}
    <div class="carriage-item form-row">
      <div class="form-group">
        <label>系列</label>
        <select name="series_{{ item.id }}" onchange="handleSeriesChange(this)">
          {% for series in carriage_series %}
          <option value="{{ series.id }}" {{ 'selected' if series.id == item.model.series_id else '' }}>{{ series.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>型号</label>
        <select name="model_{{ item.id }}">
          {% for model in carriage_models %}
          <option value="{{ model.id }}" {{ 'selected' if model.id == item.model_id else '' }}>{{ model.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>车辆号</label>
        <input type="text" name="car_number_{{ item.id }}" value="{{ item.car_number }}">
      </div>
      <div class="form-group">
        <label>颜色</label>
        <input type="text" name="color_{{ item.id }}" value="{{ item.color }}">
      </div>
      <div class="form-group">
        <label>灯光</label>
        <input type="text" name="lighting_{{ item.id }}" value="{{ item.lighting }}">
      </div>
      <button type="button" onclick="removeCarriageRow(this)">删除</button>
    </div>
    {% endfor %}
  </div>

  <button type="button" onclick="addCarriageRow()">添加车厢</button>
  <button type="submit">保存</button>
  <a href="{{ url_for('carriage.carriage') }}" class="btn-cancel">取消</a>
</form>

{% if errors %}
<div class="error">
  {% for error in errors %}
  <p>{{ error }}</p>
  {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  window.carriageSeriesData = [
    {% for series in carriage_series %}
    { id: '{{ series.id }}', name: '{{ series.name | replace("'", "\\'") }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  window.carriageModelData = [
    {% for model in carriage_models %}
    { id: '{{ model.id }}', name: '{{ model.name | replace("'", "\\'") }}', series_id: '{{ model.series_id or '' }}' }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
</script>
{% endblock %}
