{#
表单字段宏集合
包含常用的表单输入组件
#}


{# 可搜索下拉选择框（推荐使用） #}
{% macro autocomplete_field(name, label, items, required=false, value=null, text_value=null, id=null, onchange=null, field_class=null) %}
<div class="form-group{% if field_class %} {{ field_class }}{% endif %}">
  <label for="{{ id or name }}_text">{{ label }}{% if required %} *{% endif %}</label>
  <div class="autocomplete-wrapper">
    <input type="text" id="{{ id or name }}_text" name="{{ name }}_text"
        {% if required %}required{% endif %}
        autocomplete="off">
    <input type="hidden" id="{{ id or name }}" name="{{ name }}"
        {% if value is not none %}value="{{ value }}"{% endif %}>
  </div>
  <script>
  (function() {
    var options = [
      {% for item in items %}
      { id: '{{ item.id }}', name: {{ item.name | tojson }} }{% if not loop.last %},{% endif %}
      {% endfor %}
    ];
    var initialValue = {{ (value or '') | tojson }};
    var initialText = {{ (text_value or '') | tojson }};
    var config = {
      {% if onchange %}
      onchange: function(id, name) { {{ onchange }} }
      {% endif %}
    };

    // 延迟初始化，确保 DOM 和 AutocompleteManager 都已加载
    function initAutocomplete() {
      AutocompleteManager.init('{{ id or name }}_text', '{{ id or name }}', options, config);
      // 使用 !== '' 检查，允许 text_value 为空但 value 存在的情况
      if (initialValue !== '' && initialValue !== null && initialValue !== undefined) {
        AutocompleteManager.setValue('{{ id or name }}_text', initialValue, initialText);
      }
    }

    if (typeof AutocompleteManager !== 'undefined') {
      initAutocomplete();
    } else {
      document.addEventListener('DOMContentLoaded', initAutocomplete);
    }
  })();
  </script>
</div>
{% endmacro %}


{# 通用下拉选择框 #}
{% macro select_field(name, label, items, required=false, value=null, id=null, onchange=null) %}
<div class="form-group">
  <label for="{{ id or name }}">{{ label }}{% if required %} *{% endif %}</label>
  <select id="{{ id or name }}" name="{{ name }}"
      {% if required %}required{% endif %}
      {% if onchange %}onchange="{{ onchange }}"{% endif %}>
    <option value="">请选择</option>
    {% for item in items %}
    <option value="{{ item.id }}"
      {% if value == item.id %}selected{% endif %}>
      {{ item.name }}
    </option>
    {% endfor %}
  </select>
</div>
{% endmacro %}


{# 简单下拉选择框（自定义 value 和 text 字段）#}
{% macro select_field_custom(name, label, items, value_field, text_field, required=false, value=null, id=null, onchange=null) %}
<div class="form-group">
  <label for="{{ id or name }}">{{ label }}{% if required %} *{% endif %}</label>
  <select id="{{ id or name }}" name="{{ name }}"
      {% if required %}required{% endif %}
      {% if onchange %}onchange="{{ onchange }}"{% endif %}>
    <option value="">请选择</option>
    {% for item in items %}
    <option value="{{ item[value_field] }}"
      {% if value == item[value_field] %}selected{% endif %}>
      {{ item[text_field] }}
    </option>
    {% endfor %}
  </select>
</div>
{% endmacro %}


{# 比例选择框 #}
{% macro scale_select(name='scale', label='比例', required=true, value='HO', id=null) %}
<div class="form-group">
  <label for="{{ id or name }}">{{ label }}{% if required %} *{% endif %}</label>
  <select id="{{ id or name }}" name="{{ name }}" {% if required %}required{% endif %}>
    <option value="HO" {% if value == 'HO' %}selected{% endif %}>HO</option>
    <option value="N" {% if value == 'N' %}selected{% endif %}>N</option>
  </select>
</div>
{% endmacro %}


{# 布尔选择框（有/无）#}
{% macro boolean_select(name, label, required=false, value=null, id=null, default=null, field_class=null) %}
<div class="form-group{% if field_class %} {{ field_class }}{% endif %}">
  <label for="{{ id or name }}">{{ label }}</label>
  <select id="{{ id or name }}" name="{{ name }}" {% if required %}required{% endif %}>
    <option value="">请选择</option>
    <option value="true" {% if (value == true) or (value == null and default == true) %}selected{% endif %}>有</option>
    <option value="false" {% if (value == false) or (value == null and default == false) %}selected{% endif %}>无</option>
  </select>
</div>
{% endmacro %}


{# 文本输入框 #}
{% macro text_field(name, label, required=false, value=null, id=null, placeholder=null, type='text', field_class=null) %}
<div class="form-group{% if field_class %} {{ field_class }}{% endif %}">
  <label for="{{ id or name }}">{{ label }}{% if required %} *{% endif %}</label>
  <input type="{{ type }}" id="{{ id or name }}" name="{{ name }}"
      {% if required %}required{% endif %}
      {% if value %}value="{{ value }}"{% endif %}
      {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}>
</div>
{% endmacro %}


{# 数字输入框 #}
{% macro number_field(name, label, required=false, value=null, id=null, min=null, max=null, field_class=null) %}
<div class="form-group{% if field_class %} {{ field_class }}{% endif %}">
  <label for="{{ id or name }}">{{ label }}{% if required %} *{% endif %}</label>
  <input type="number" id="{{ id or name }}" name="{{ name }}"
      {% if required %}required{% endif %}
      {% if value is not none %}value="{{ value }}"{% endif %}
      {% if min is not none %}min="{{ min }}"{% endif %}
      {% if max is not none %}max="{{ max }}"{% endif %}>
</div>
{% endmacro %}


{# 日期输入框 #}
{% macro date_field(name, label, required=false, value=null, id=null, field_class=null) %}
<div class="form-group{% if field_class %} {{ field_class }}{% endif %}">
  <label for="{{ id or name }}">{{ label }}</label>
  <input type="date" id="{{ id or name }}" name="{{ name }}"
      {% if required %}required{% endif %}
      {% if value %}value="{{ value }}"{% endif %}>
</div>
{% endmacro %}


{# 价格输入框（带提示）#}
{% macro price_field(name='price', label='价格', value=null, id=null, field_class=null, placeholder='支持表达式计算') %}
<div class="form-group{% if field_class %} {{ field_class }}{% endif %}">
  <label for="{{ id or name }}">{{ label }}</label>
  <input type="text" id="{{ id or name }}" name="{{ name }}"
      {% if value %}value="{{ value }}"{% endif %}
      placeholder="{{ placeholder }}">
</div>
{% endmacro %}


{# 表单行（包含多个字段）#}
{% macro form_row(fields) %}
<div class="form-row">
  {% for field in fields %}
  {{ field }}
  {% endfor %}
</div>
{% endmacro %}
