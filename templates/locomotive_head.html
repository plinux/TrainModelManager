{% extends "base.html" %}
{% from "macros/form.html" import autocomplete_field, text_field, date_field, price_field, scale_select, boolean_select %}
{% from "macros/table.html" import action_buttons, relation_name %}

{% block title %}先头车模型 - 火车模型管理系统{% endblock %}

{% block content %}
<h1>先头车模型</h1>

<form id="locomotive-head-form" onsubmit="event.preventDefault(); submitFormAjax(this, '/api/locomotive-head/add');">
  <div class="form-row">
    {{ autocomplete_field('model_id', '型号', trainset_models, required=true) }}
    {{ autocomplete_field('depot_id', '动车段', depots) }}
    {{ scale_select() }}
    {{ autocomplete_field('brand_id', '品牌', brands, required=true) }}
    {{ text_field('special_color', '特涂') }}
  </div>

  <div class="form-row">
    {{ boolean_select('head_light', '头车灯', default=true) }}
    {{ text_field('interior_light', '室内灯') }}
    {{ text_field('item_number', '货号') }}
    {{ price_field() }}
    {{ autocomplete_field('merchant_id', '购买商家', merchants) }}
    {{ date_field('purchase_date', '购买日期') }}
  </div>

  <div class="form-row">
    {{ text_field('product_url', '产品地址') }}
  </div>

  <button type="submit">添加</button>
</form>

<div class="table-wrapper">
  <table id="locomotive-head-table" class="sortable-filterable">
    <thead>
      <tr>
        <th data-sort="model" data-filter="model">型号</th>
        <th data-sort="brand" data-filter="brand">品牌</th>
        <th data-sort="depot" data-filter="depot">动车段</th>
        <th data-sort="scale" data-filter="scale">比例</th>
        <th data-sort="special_color" data-filter="special_color">特涂</th>
        <th data-sort="head_light" data-filter="head_light">头车灯</th>
        <th data-sort="interior_light" data-filter="interior_light">室内灯</th>
        <th data-sort="item_number" data-filter="item_number">货号</th>
        <th data-sort="price">总价</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      {% for head in locomotive_heads %}
      <tr data-model="{{ head.model.name }}" data-brand="{{ head.brand.name }}" data-depot="{{ head.depot.name if head.depot else '' }}" data-scale="{{ head.scale }}" data-special_color="{{ head.special_color or '' }}" data-head_light="{{ '有' if head.head_light else '无' }}" data-interior_light="{{ head.interior_light or '' }}" data-item_number="{{ head.item_number or '' }}" data-price="{{ head.total_price or 0 }}">
        <td>{{ head.model.name }}</td>
        <td>{{ head.brand.name }}</td>
        <td>{{ relation_name(head.depot) }}</td>
        <td>{{ head.scale }}</td>
        <td>{{ head.special_color }}</td>
        <td>{{ '有' if head.head_light else '无' }}</td>
        <td>{{ head.interior_light }}</td>
        <td class="item-number-cell">
          {% if head.product_url %}
          <a href="{{ head.product_url }}" target="_blank" title="点击打开产品页面">{{ head.item_number }}</a>
          {% else %}
          {{ head.item_number }}
          {% endif %}
        </td>
        <td>{{ head.total_price }}</td>
        <td class="action-cell">
          {% set search_url = head.brand.search_url %}
          {% set item_number = head.item_number %}
          {% if search_url and item_number %}
          <button type="button" class="btn-search" onclick='searchProduct(this, {{ search_url | tojson }}, {{ item_number | tojson }})' title="在官网搜索此货号">检索</button>
          {% else %}
          <button type="button" class="btn-search" disabled title="缺少品牌搜索URL或货号">检索</button>
          {% endif %}
          <a href="{{ url_for('locomotive_head.edit_locomotive_head', id=head.id) }}" class="btn-edit">编辑</a>
          <form action="{{ url_for('locomotive_head.delete_locomotive_head', id=head.id) }}" method="POST" onsubmit="return confirm('确定删除？')">
            <button type="submit" class="btn-danger">删除</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
  initTableSortFilter('locomotive-head-table');

  // 搜索产品
  function searchProduct(btn, searchUrl, itemNumber) {
    if (!searchUrl || !itemNumber) return;
    var url = searchUrl.replace('{query}', encodeURIComponent(itemNumber));
    window.open(url, '_blank');
  }
</script>
{% endblock %}
